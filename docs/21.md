# The Secrets Vault

Я не хочу слишком углубляться в развертывание, но давайте проведем быстрый курс «Как развернуть ваше приложение Symfony 101». Вот идея.

## Deployment 101

Шаг 1: Вам нужно каким-то образом перенести весь ваш код на производственную машину, а затем запустить

```
composer install
```

для заполнения каталога vendor/.

Шаг 2: Каким-то образом создайте файл .env.local со всеми переменными вашей производственной среды, который будет включать APP_ENV=prod, чтобы вы находились в среде prod.

И Шаг 3: запустить

```
php bin/console cache:clear
```

что очистит кэш в производственной среде, а затем

```
php bin/console cache:warmup
```

для "разогрева" кэша. Возможно, есть несколько других команд, например, запуск миграций вашей базы данных... но это общая идея. А в документации Symfony есть больше подробностей.

## По возможности используйте реальные переменные среды

В любом случае, самая сложная часть процесса — это шаг 2 — создание файла .env.local со всеми вашими производственными значениями, которые будут включать такие вещи, как ключи API, данные о подключении к вашей базе данных и многое другое.

Теперь, если ваша хостинговая платформа позволяет вам хранить реальные переменные окружения прямо внутри себя, проблема решена! Если вы устанавливаете реальные переменные окружения, то нет никакой необходимости управлять файлом .env.local вообще. Как только вы развернете, Symfony мгновенно увидит и будет использовать реальные переменные окружения. Это то, что мы делаем для Symfonycasts.

## Создание .env.local во время развертывания?

Но если это не вариант для вас, вам нужно будет как-то предоставить вашей системе развертывания доступ к вашим конфиденциальным значениям, чтобы она могла создать файл .env.local. Но... поскольку мы не фиксируем ни одно из этих значений в нашем репозитории, где мы должны их хранить?

Одним из вариантов обработки конфиденциальных значений является хранилище секретов Symfony. Это набор файлов, содержащих переменные окружения в зашифрованном виде. Эти файлы можно безопасно зафиксировать в вашем репозитории... потому что они зашифрованы!

## Creating the dev Vault

Если вы хотите хранить секреты в хранилище, вам понадобится два из них: одно для среды разработки и одно для среды производства. Сначала мы создадим эти два хранилища... затем я объясню, как считывать из них значения.

Начните с создания среды разработки. Запустите:

```
php bin/console secrets:set GITHUB_TOKEN
```

Передайте этот GITHUB_TOKEN, который является секретом, который мы хотим установить. Затем он запрашивает наше «секретное значение». Поскольку это хранилище для среды разработки, мы хотим поместить что-то, что безопасно для всех. Я объясню почему через минуту. Я скажу CHANGEME. Вы не можете видеть, как я это печатаю... только потому, что Symfony скрывает это из соображений безопасности.

Так как это первый секрет, который мы создали, Symfony автоматически создал хранилище секретов за кулисами... которое по сути является набором файлов, которые находятся в config/secrets/dev/. Для хранилища dev мы собираемся зафиксировать все эти файлы в репозитории. Давайте сделаем это. Добавим весь каталог secrets:

```
git add config/secrets/dev
```

Затем выполните коммит с помощью:

```
git commit -m "adding dev secrets vault"
```

## Файлы Секретного хранилища

Вот краткое объяснение файлов. dev.list.php хранит список значений, которые находятся внутри хранилища, dev.GITHUB_TOKEN.28bd2f.php хранит фактическое зашифрованное значение, а dev.encrypt.public.php — это криптографический ключ, который позволяет разработчикам в вашей команде добавлять больше секретов. Так что если другой разработчик закроет проект, у него будет этот файл... так что он сможет добавить больше секретов. Наконец, dev.decrypt.private.php — это секретный ключ, который позволяет нам расшифровывать и читать значения в хранилище.

Как только файлы хранилища появятся, Symfony автоматически откроет их, расшифрует секреты и выставит их как переменные среды! Но об этом подробнее через несколько минут.

## Storing the dev Decrypt Key?

Но подождите: мы действительно просто передали ключ дешифрования в репозиторий? Да! Обычно это было бы табу! Зачем вам утруждать себя шифрованием значений... просто чтобы хранить ключ дешифрования прямо рядом с ними?

Причина, по которой мы делаем именно это, заключается в том, что это наше хранилище разработки, а это значит, что мы будем хранить только те значения, которые безопасны для просмотра всеми разработчиками. Хранилище разработки будет использоваться только локальной разработкой... и мы хотим, чтобы наши товарищи по команде могли извлекать код и читать его без каких-либо проблем.

Хорошо, на этом этапе у нас есть хранилище dev, которое Symfony будет автоматически использовать в среде dev. Далее: давайте создадим хранилище prod, которое будет содержать действительно секретные значения. Затем мы изучим связь между секретами хранилища и переменными среды... а также простой способ визуализации всего этого.