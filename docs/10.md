# The "prod" Environment

Наше приложение в настоящее время работает в среде разработки. Давайте переключим его в среду prod..., которую вы бы использовали в рабочей среде. Временно измените APP_ENV=dev на prod:

.env

```
###> symfony/framework-bundle ###
APP_ENV=prod
// ... lines 18 - 20
```

затем перейдите и обновитесь. Ого! Панель инструментов веб-отладки исчезла. Это... имеет смысл! Весь пакет веб-профилировщика не включен в среде prod.

Вы также заметите, что дамп из нашего контроллера появляется в верхней части страницы. Веб-профилировщик обычно фиксирует это и отображает внизу на панели инструментов веб-отладки. Но... поскольку вся эта система больше не включена, теперь она выдает дамп прямо там, где вы ее вызываете.

И есть много других отличий, например, логер, который теперь ведет себя по-другому благодаря конфигурации в monolog.yaml.

## Очистка кэша prod

Изменился и способ построения страниц. Например, Symfony кэширует много файлов... но вы не замечаете этого в среде разработки. Это потому, что Symfony очень умный и автоматически перестраивает этот кэш, когда мы изменяем определенные файлы. Однако в среде prod этого не происходит.

Проверьте это! Откройте templates/base.html.twig... и измените заголовок страницы на Stirred Vinyl. Если вы вернетесь и обновите... посмотрите здесь! Никаких изменений! Сами шаблоны Twig кэшируются. В среде dev Symfony перестраивает этот кэш для нас. Но в среде prod? Нет! Нам нужно очистить его вручную.

Как? На терминале запустите:

```
php bin/console cache:clear
```

Обратите внимание, что он говорит, что очищает кэш для среды prod. Таким образом, так же, как наше приложение всегда работает в определенной среде, консольные команды также работают в определенной среде. И он считывает тот же флаг APP_ENV. Так как у нас здесь APP_ENV=prod, cache:clear знал, что он должен работать в среде prod и очищать кэш для этой среды.

Благодаря этому, когда мы обновляем... теперь название обновляется. Я изменю его обратно на наше крутое название, Mixed Vinyl.

## Изменение адаптера кэша только для prod

Давайте попробуем что-нибудь еще! Откройте config/packages/cache.yaml. Наша служба кэширования в настоящее время использует ArrayAdapter, который является поддельным кэшем. Это может быть здорово для разработки, но не принесет большой пользы в производстве:

config/packages/cache.yaml

```yaml
framework:
    cache:
// ... lines 3 - 10
        app: cache.adapter.array
```

Давайте посмотрим, сможем ли мы переключить его обратно на адаптер файловой системы, но только для среды prod. Как? Здесь внизу используйте when@prod, а затем повторите те же ключи. Итак, framework, cache и затем app. Установите это на нужный нам адаптер, который называется cache.adapter.filesystem:

```yaml
framework:
    cache:
// ... lines 3 - 10
        app: cache.adapter.array
// ... lines 12 - 20
when@prod:
    framework:
        cache:
            app: cache.adapter.filesystem
```

Будет очень легко увидеть, работает ли это, потому что мы все еще сбрасываем службу кэша в нашем контроллере. Прямо сейчас это ArrayAdapter. Если мы обновимся... сюрприз! Это все еще ArrayAdapter. Почему? Потому что мы в среде prod... и практически каждый раз, когда вы вносите изменения в среду prod, вам нужно перестроить свой кэш.

Вернитесь к своему терминалу и запустите

```
php bin/console cache:clear
```

снова и теперь... понял - FilesystemAdapter!

Но... давайте изменим эту конфигурацию. Скопируем cache.adapter.array и изменим его на filesystem. Мы будем использовать его по умолчанию. Затем внизу изменим на when@dev, а это на cache.adapter.array:

```yaml
framework:
    cache:
// ... lines 3 - 10
        app: cache.adapter.filesystem
// ... lines 12 - 20
when@dev:
    framework:
        cache:
            app: cache.adapter.array
```

Зачем я это делаю? Ну, это буквально не имеет никакого значения в средах разработки и производства. Но если мы решим начать писать тесты позже, которые будут работать в тестовой среде, с этой новой конфигурацией, тестовая среда будет использовать ту же службу кэширования, что и производственная... что, вероятно, более реалистично и лучше для тестирования.

Чтобы убедиться, что это все еще работает, очистите кэш еще раз. Обновите и... он работает! У нас все еще есть FilesystemAdapter. И... если мы переключимся обратно в среду разработки в .env:

###> symfony/framework-bundle ###
APP_ENV=dev

и обновите... да! Панель инструментов веб-отладки вернулась, и здесь внизу мы снова используем ArrayAdapter!

Теперь, на самом деле, вы, вероятно, никогда не переключитесь на среду prod, пока разрабатываете локально. С ней трудно работать... и в этом просто нет смысла! Среда prod на самом деле предназначена для производства! И поэтому вы запустите эту команду bin/console cache:clear во время развертывания... но, вероятно, почти никогда на локальной машине.

Прежде чем продолжить, зайдите в VinylController, перейдите в browse() и извлеките этот dump():

src/Controller/VinylController.php

```php
class VinylController extends AbstractController
{
// ... lines 15 - 32
    #[Route('/browse/{slug}', name: 'app_browse')]
    public function browse(HttpClientInterface $httpClient, CacheInterface $cache, string $slug = null): Response
    {
        $genre = $slug ? u(str_replace('-', ' ', $slug))->title(true) : null;
        $mixes = $cache->get('mixes_data', function(CacheItemInterface $cacheItem) use ($httpClient) {
            $cacheItem->expiresAfter(5);
            $response = $httpClient->request('GET', 'https://raw.githubusercontent.com/SymfonyCasts/vinyl-mixes/main/mixes.json');
            return $response->toArray();
        });
        return $this->render('vinyl/browse.html.twig', [
            'genre' => $genre,
            'mixes' => $mixes,
        ]);
    }
}
```

Хорошо, проверка статуса! Во-первых, все в Symfony выполняется службой. Во-вторых, пакеты предоставляют нам сервисы. И в-третьих, мы можем контролировать, как эти сервисы создаются с помощью различных конфигураций пакетов в config/packages/.

Теперь давайте сделаем еще один важный шаг вперед и создадим нашу собственную службу.